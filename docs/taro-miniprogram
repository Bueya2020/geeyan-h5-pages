Taroè°ƒç”¨æ”¯ä»˜æ¥å£ä¸æ”¹UI

å¬å…¨æ–‡
æ—¢ç„¶ä½ æ˜¯ â€‹â€‹Taro å¼€å‘çš„â€‹â€‹ï¼Œä½†â€‹â€‹ä¸æƒ³æ”¹åŠ¨ UIâ€‹â€‹ï¼ŒåŒæ—¶â€‹â€‹éœ€è¦è°ƒç”¨å°ç¨‹åºæ”¯ä»˜æ¥å£â€‹â€‹ï¼Œé‚£æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ â€‹â€‹æ··åˆæ–¹æ¡ˆâ€‹â€‹ï¼š

â€‹â€‹æ ¸å¿ƒæ€è·¯â€‹â€‹
â€‹â€‹ä¸»é¡µé¢ç”¨ web-view åŠ è½½ H5ï¼ˆUI å®Œå…¨ä¸å˜ï¼‰â€‹â€‹
â€‹â€‹æ”¯ä»˜ç­‰åŸç”ŸåŠŸèƒ½é€šè¿‡ postMessage é€šä¿¡è°ƒç”¨â€‹â€‹
è¿™æ ·æ—¢èƒ½ä¿ç•™ H5 çš„ UIï¼Œåˆèƒ½ä½¿ç”¨å°ç¨‹åºçš„åŸç”Ÿèƒ½åŠ›ï¼ˆå¦‚æ”¯ä»˜ï¼‰ã€‚

â€‹â€‹å…·ä½“å®ç°æ­¥éª¤â€‹â€‹
â€‹â€‹1. ç¡®ä¿ H5 é¡µé¢æ”¯æŒé€šä¿¡â€‹â€‹
åœ¨ä½ çš„ H5 é¡µé¢é‡Œï¼ŒåŠ å…¥ â€‹â€‹JS ç›‘å¬â€‹â€‹ï¼Œæ¥æ”¶æ¥è‡ªå°ç¨‹åºçš„æ”¯ä»˜è¯·æ±‚ï¼š

// H5 é¡µé¢ä»£ç ï¼ˆå‡è®¾æ˜¯ Vue/React/åŸç”ŸJSï¼‰
window.addEventListener('message', (event) => {
  if (event.data.type === 'requestPayment') {
    // è¿™é‡Œå¯ä»¥å¼¹çª—æç¤ºç”¨æˆ·ç¡®è®¤æ”¯ä»˜
    console.log('æ”¶åˆ°æ”¯ä»˜è¯·æ±‚:', event.data.orderInfo);
    
    // å›ä¼ æ¶ˆæ¯ç»™å°ç¨‹åºï¼Œè®©å®ƒè°ƒèµ·æ”¯ä»˜
    if (window.ReactNativeWebView) {
      // å¦‚æœæ˜¯ React Native WebView
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'confirmPayment',
        orderId: event.data.orderId
      }));
    } else if (window.parent) {
      // æ™®é€š WebView
      window.parent.postMessage({
        type: 'confirmPayment',
        orderId: event.data.orderId
      }, '*');
    }
  }
});
â€‹â€‹2. åœ¨ Taro å°ç¨‹åºé‡ŒåµŒå…¥ web-viewâ€‹â€‹
â€‹â€‹(1) åˆ›å»º web-view é¡µé¢â€‹â€‹
åœ¨ Taro é¡¹ç›®ä¸­ï¼Œæ–°å»ºä¸€ä¸ªé¡µé¢ä¸“é—¨æ”¾ web-viewï¼š

taro create --name webviewPage
ç„¶ååœ¨ src/pages/webviewPage/index.config.ts é‡Œé…ç½®å¯¼èˆªæ ï¼š

export default {
  navigationBarTitleText: 'æ”¯ä»˜é¡µé¢'
}
â€‹â€‹(2) åœ¨ web-view é‡ŒåŠ è½½ä½ çš„ H5â€‹â€‹
// src/pages/webviewPage/index.tsx
import { WebView } from '@tarojs/components';

export default function WebviewPage() {
  return (
    <WebView src="https://ä½ çš„H5åŸŸå.com/pay-page" />
  );
}
â€‹â€‹(3) ç›‘å¬ H5 å‘æ¥çš„æ”¯ä»˜è¯·æ±‚â€‹â€‹
ç”±äº Taro çš„ web-view æœ¬èº«ä¸æ”¯æŒç›´æ¥ç›‘å¬ postMessageï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© Taro.eventCenter æˆ–å…¨å±€å˜é‡ï¼š

import Taro from '@tarojs/taro';
import { WebView } from '@tarojs/components';

export default function WebviewPage() {
  // ç›‘å¬ H5 å‘æ¥çš„æ”¯ä»˜ç¡®è®¤
  const handleMessage = (e) => {
    if (e.detail.data && e.detail.data.type === 'confirmPayment') {
      // è°ƒç”¨å°ç¨‹åºæ”¯ä»˜ API
      Taro.requestPayment({
        timeStamp: 'æ—¶é—´æˆ³',
        nonceStr: 'éšæœºå­—ç¬¦ä¸²',
        package: 'prepay_id=xxx',
        signType: 'MD5',
        paySign: 'ç­¾å',
        success: (res) => {
          console.log('æ”¯ä»˜æˆåŠŸ', res);
          // å¯ä»¥é€šçŸ¥ H5 æ”¯ä»˜æˆåŠŸ
        },
        fail: (err) => {
          console.error('æ”¯ä»˜å¤±è´¥', err);
        }
      });
    }
  };

  return (
    <WebView 
      src="https://ä½ çš„H5åŸŸå.com/pay-page" 
      onMessage={handleMessage} 
    />
  );
}
â€‹â€‹3. é…ç½®ä¸šåŠ¡åŸŸåâ€‹â€‹
â€‹â€‹åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°â€‹â€‹ â†’ â€‹â€‹å¼€å‘ç®¡ç†â€‹â€‹ â†’ â€‹â€‹å¼€å‘è®¾ç½®â€‹â€‹ â†’ â€‹â€‹ä¸šåŠ¡åŸŸåâ€‹â€‹
æ·»åŠ ä½ çš„ H5 åŸŸåï¼ˆå¦‚ https://ä½ çš„H5åŸŸå.comï¼‰
ä¸Šä¼ éªŒè¯æ–‡ä»¶åˆ°ä½ çš„æœåŠ¡å™¨æ ¹ç›®å½•
â€‹â€‹4. æ”¯ä»˜æµç¨‹äº¤äº’â€‹â€‹
â€‹â€‹ç”¨æˆ·åœ¨ H5 é¡µé¢ç‚¹å‡»æ”¯ä»˜æŒ‰é’®â€‹â€‹
â€‹â€‹H5 é€šè¿‡ postMessage é€šçŸ¥å°ç¨‹åºâ€‹â€‹
â€‹â€‹å°ç¨‹åºè°ƒèµ· Taro.requestPaymentâ€‹â€‹
â€‹â€‹æ”¯ä»˜å®Œæˆåï¼Œå°ç¨‹åºé€šçŸ¥ H5 æ›´æ–°çŠ¶æ€â€‹â€‹
â€‹â€‹å…³é”®é—®é¢˜ & è§£å†³æ–¹æ¡ˆâ€‹â€‹
â€‹â€‹Q1: web-view é‡Œèƒ½ç›´æ¥è°ƒæ”¯ä»˜å—ï¼Ÿâ€‹â€‹
âŒ â€‹â€‹ä¸è¡Œï¼â€‹â€‹ å¾®ä¿¡é™åˆ¶ web-view ä¸èƒ½ç›´æ¥è°ƒç”¨æ”¯ä»˜ï¼Œå¿…é¡»é€šè¿‡å°ç¨‹åºåŸç”Ÿ APIã€‚

â€‹â€‹Q2: H5 æ€ä¹ˆçŸ¥é“æ”¯ä»˜æˆåŠŸäº†ï¼Ÿâ€‹â€‹
âœ… â€‹â€‹æ–¹æ¡ˆâ€‹â€‹ï¼šæ”¯ä»˜æˆåŠŸåï¼Œå°ç¨‹åºå¯ä»¥é€šè¿‡ Taro.navigateTo è·³è½¬å› H5ï¼Œå¹¶å¸¦ä¸Šæ”¯ä»˜çŠ¶æ€å‚æ•°ï¼š

Taro.navigateTo({
  url: `/pages/webviewPage/index?payStatus=success&orderId=123`
});
ç„¶ååœ¨ H5 é‡Œè§£æ URL å‚æ•°ï¼Œæ›´æ–° UIã€‚

â€‹â€‹Q3: å¦‚ä½•è°ƒè¯• postMessageï¼Ÿâ€‹â€‹
âœ… â€‹â€‹æ–¹æ¡ˆâ€‹â€‹ï¼š

â€‹â€‹å°ç¨‹åºç«¯â€‹â€‹ï¼šç”¨ console.log(e.detail.data) æŸ¥çœ‹æ”¶åˆ°çš„æ¶ˆæ¯ã€‚
â€‹â€‹H5 ç«¯â€‹â€‹ï¼šç”¨ Chrome DevTools çš„ Application â†’ Local Storage æ¨¡æ‹Ÿ postMessageã€‚
â€‹â€‹æ€»ç»“â€‹â€‹
æ–¹æ¡ˆ	æ˜¯å¦æ”¹ UI	èƒ½å¦è°ƒç”¨æ”¯ä»˜	å¤æ‚åº¦
â€‹â€‹çº¯ web-viewâ€‹â€‹	âŒ ä¸æ”¹	âŒ ä¸èƒ½	â­
â€‹â€‹Taro è½¬æ¢ä»£ç â€‹â€‹	âœ… è¦æ”¹	âœ… èƒ½	â­â­â­
â€‹â€‹web-view + postMessageâ€‹â€‹	âŒ ä¸æ”¹	âœ… èƒ½	â­â­
â€‹â€‹ä½ çš„éœ€æ±‚æœ€é€‚åˆ web-view + postMessage æ–¹æ¡ˆï¼â€‹â€‹ ğŸš€

â€‹â€‹ä¸æ”¹ UIâ€‹â€‹ï¼šH5 é¡µé¢åŸæ ·å±•ç¤ºã€‚
â€‹â€‹æ”¯æŒæ”¯ä»˜â€‹â€‹ï¼šé€šè¿‡é€šä¿¡è®©å°ç¨‹åºè°ƒæ”¯ä»˜æ¥å£ã€‚
â€‹â€‹å¼€å‘æˆæœ¬ä½â€‹â€‹ï¼šåªéœ€å°‘é‡ JS äº¤äº’ä»£ç ã€‚